\section{Анализ и обработка результатов~--- утилита командной строки {\tt racs}}
Для многопараметрического поиска, анализа и обработки результатов численного моделирования используется утилита командной строки \verb'racs'.
Утилита написана на языке \verb'Python' и имеет интерфейс командной строки. В 2010-м году предпринимались попытки создать
версию с оконным интерфейсом пользователя, однако быстро выяснилось что это не дает никаких преимуществ, но при этом
существенно усложняется взаимодействие с другими утилитами командной строки, кроме того возникают проблемы с удаленной работой по \verb'ssh'.

Утилита может быть запущена без аргументов или с аргументом \verb'--help' для просмотра справки.

Утилита может быть запущена с аргументом \verb'--ghelp' для просмотра справки по глобальному пространству имен, использующемуся при вычислении выражений.

Утилита может быть запущена с одним аргументом~--- путем к отдельному существующему расчету для
просмотра метаинформации (содержимого файла .RACS').

Во всех остальных случаях утилита запускается в виде
\begin{verbatim}
  racs REPO/ EXPR ...  ACTION [ACTIONS-ARGUMENTS]
\end{verbatim}

Утилита способна  совместно обрабатывать нескольких репозиториев,
репозитории обрабатываются последовательно (в том порядке в котором были указаны) результаты сливаются в общую выборку (совокупность расчетов).
Репозитории указываются с символом \verb|'/'| на конце, и могут указываться вперемешку с выражениями,
расположение репозиториев относительно выражений значения не имеет.

Выражения~--- фрагменты кода на языке \verb'Python', которые вычисляются для каждого расчета выборки, при этом словарь с параметрами
расчета выступает как локальное пространство имен,  а в качестве глобального пространства выступает специально сформированный словарь с рядом
служебных функций, макросов, функций из модуля \verb'math' и т.д. Вначале и в конце выражений могут присутствовать специальные символы,
управляющие режимами вычисления выражений фильтрации, сортировки и постобработки результатов. В итоге выборку можно рассматривать как таблицу,
каждой строке которой отвечает расчет, а колонке значение вычисленного выражения.

Выражения могут иметь синтаксис \verb'[~|^][TITLE=][$]EXPR[?|%|#][-]' либо \verb'[$]EXPR![!]' либо \verb'TAG+'.

Если в конце выражения стоит символ \verb|'?'|, производится фильтрация по результатам вычисления выражения~--- остаются лишь те расчеты,
для которых выражение дает истину при приведении к булевому типу. Допускается фильтрация по нескольким выражениям, в итоге они фактически
будут объединены логическим \verb'AND'. После фильтрации колонки с такими выражениями выбрасываются из таблицы.

Если в конце выражения стоит символ \verb|'-'| (всегда в {\bf самом} конце), после обработки (например сортировки) такая колонка выбрасывается из таблицы. 

Если в конце выражения стоит символ \verb|'%'|, в таблицу добавляется разделитель (горизонтальная линию или пустая строка в зависимости от формата вывода)
между строками, у которых различаются значения выражения, при этом столбец может быть скрыт как \verb'EXPR%-'.

Если в конце выражения стоит символ \verb|'#'|, из выборки удаляются все расчеты с одинаковыми значениями выражения кроме первого,
при этом столбец может быть скрыт как \verb'EXPR#-' (аналог функции \verb'DISTINCT' в \verb'SQL').

Рассмотрим теперь специальные символы, которые могут появляться вначале выражений.
Аргументы вида \verb'... ~EXPR1 ... ^EXPR2...' означают,
что необходимо сортировать расчеты  в выборке (после всех фильтров) по результату вычисления выражений, знак \verb'~' означает
сортировку по возрастанию, знак \verb'^' означает сортировку по убыванию, сортировки проводятся последовательно
(сортировка по \verb'EXPR1' затем по \verb'EXPR2' и т.д.).

Символ \verb|'$'| означает, что 
выражение должно быть отформатировано по словарю с параметрами расчета при помощи оператора \verb'%' и выполнено как команда \verb'shell',
результатом является стандартный вывод команды (строка), к результатам
могут применяться символы \verb'~^?#%-'.

В случае сложных выражений можно давать краткие заголовки колонкам таблицы как \verb'TITLE=...', при этом допустима сортировка, фильтрация и т.д.

Описанные выше возможности не могут модифицировать расчеты выборки (за исключением команд \verb'shell') поскольку выполняются при помощи функции \verb'eval'.
Для модификации расчетов используется синтаксис \verb'TAG+' (добавляет тэг \verb'TAG') либо  \verb|'[$]EXPR!'| (вычисление выражения функцией \verb'exec'
в словаре с параметрами расчета). Два восклицательных знака означают вычисление выражения функцией \verb'exec'
в глобальном словаре.

Символ \verb|'$'| означает, что 
выражение должно быть отформатировано по словарю с параметрами расчета при помощи оператора \verb'%' и выполнено как команда \verb'shell',
а его результаты уже будут выполняться функцией \verb'exec'. Это позволяет писать различные утилиты для сложной постобработки расчетов и
легко заносить результаты их работы под \verb'RACS'.

Колонки с выражениями, модифицирующими расчеты в выборке, всегда выбрасываются из таблицы.

Вне зависимости от того, в каком порядке были выставлены выражения,
сначала проводится вычисление всех выражений и фильтрация (если хотя бы один из фильтров не пройден расчет выбрасывается из выборки немедленно),
затем вся сортировка, затем обрабатываются все символы \verb|'#'|, затем вставляются горизонтальные сепараторы,
и только после этого скрываются (по необходимости) оставшиеся столбцы.

Если в процессе вычисления выражения генерируется исключение, то исключение перехватывается а результатом вычисления считается значение \verb'None'.
Отчет об исключении будет выведен в стандартный поток ошибок.

В обязательном порядке должно быть указано действие над сформированной выборкой, после указания действия могут присутствовать необязательные аргументы,
относящиеся уже к этому действию. Доступны следующие действия:
\begin{itemize}
\item \verb'racs ... --keys [or|and|xor]' --- выводить сводный список имен параметров в построенной выборке, необязательный аргумент \verb'or' (по умолчанию)
  означает объединение всех имен параметров, \verb'and' пересечение и \verb'xor' исключающее или;
\item \verb'racs ... --rm' --- удалить с диска все расчеты выборки;
\item \verb'racs ... --co' или \verb'--commit' --- сохранить на диск все изменения в расчетах выборки (модификация расчетов не означает их сохранения на диск);
\item \verb'racs ... --ps [FNAME]' или \verb'--paths [FNAME]' --- вывести пути ко всем расчетам (если \verb'FNAME' не указан) либо пути
  к файлам \verb'FNAME' лежащим в директориях расчетов выборки;
\item \verb'racs ... --ast [[Y|N] TERMWIDTH]' или \verb'--astable [[Y|N] TERMWIDTH]' --- вывести выборку в виде таблицы,
  первый необязательный заголовко позволяет отключить заголовок таблицы (по умолчанию включен), второй необязательный аргумент задает ширину терминала;
\item \verb|racs ... --asd [[[head] pattern] filename]| или \verb'--astdata ...' --- вывести выборку в виде \verb'.dat'--файла (текстового)
  с заголовками в стиле утилиты \verb'gplt'. Необязательный аргумент \verb'filename' задает шаблон имени файла который будет отформатирован по словарю с
  общими (имеющими одинаковые значения) для всех расчетов выборки параметрами (по умолчанию пустая строка, то есть выводит на стандартный вывод).
  При необходимости под файл рекурсивно создаются все необходимые директории.
  Необязательный аргумент \verb'pattern' задает шаблон для имен общих для всех расчетов параметров, которые будут выведены в заголовок \verb'.dat' файла (по умолчанию пустая строка, т.е. не выводить никаких). Необязательный булевый аргумент \verb'head' указывает на необходимость вывода заголовков столбцов выборки (по умолчанию включен).
\end{itemize}
Опция \verb'--asdata' позволяет в духе идеологии \verb'Unix-Way' направлять через неименованный пайп вывод утилиты \verb'racs' на вход утилите \verb'gplt' для визуализации в \verb'gnuplot'.

Кроме того, доступны следующие опции (по умолчанию отключены):
\begin{itemize}
\item \verb'--pb' или \verb'--pbar' или \verb'--progressbar' --- отображать процесс построения выборки;
\item \verb'--csz' или \verb'--calc-size' --- определять размер расчетов (требует дополнительного времени);
\item \verb'--ctr' или \verb'--check-tree' --- двигаться вглубь репозиториев, по дереву каталогов;
\item \verb'--force' --- не запрашивать подтверждения на удаление расчетов и сохранение изменений;
\item \verb'--cl'  или \verb'--clustering' --- разворачивает значения в первой колонке горизонтально
  и кластеризует выборку по первой и второй колонке, в результате получается двумерная таблица.
\end{itemize}
Опция \verb'-clustering' особенно удобна при сравнении различных серий расчетов отличающихся одним параметром. 

Еще одной возможностью утилиты \verb'racs' является пакетная обработка выборок и вывод их в разные \verb'.dat'--файлы.
Пусть нам необходимо построить множество однотипных выборок с параметрами \verb'X' и \verb'Y', отличающихся например параметром \verb'N=2,4,8..256'.
Одна выборка может быть построена как
\begin{verbatim}
  racs repo/ N==2? ~X Y --asd > results/XY-N2.dat
\end{verbatim}
а серия выборок может быть получена средствами  \verb'shell':
\begin{verbatim}
  for N in 2 4 8 16 32 64 128 256; \
      do racs repo/ N==$N? ~X Y --asd > results/XY-N$N.dat; done
\end{verbatim}
что немного громоздко, но еще приемлемо. Однако, если речь идет о серии выборок по двум параметрам, например \verb'N' и \verb'T=0.2,0.4..2' то
в командной строке это начинает немного смахивать на кошмар:
\begin{verbatim}
  for T in `seq .2 .2 2`; do for N in 2 4 8 16 32 64 128 256; \ 
    do racs repo/ N==$N? T==$T? ~X Y --asd results/XY-T$T-N$N.dat; \ 
  done;  done
\end{verbatim}
Конечно можно написать \verb'bash'--скрипт, но \verb'racs' позволяет этого не делать:
\begin{verbatim}
  racs repo/ N: T: ~X Y --asd 'results/XY-T%(T)s-N%(N)s.dat'
\end{verbatim}

Для серийной обработки используются выражения вида \verb'[TITLE=][$]EXPR:'~--- эти выражения выделяются из общего списка аргументов,
и одновременно производится построение целой серии выборок, каждая выборка отвечает своему набору значений выражений \verb'...EXPR:'.
При выводе в \verb'.dat'--файлы производится последовательный вывод для всех выборок из серии, за счет форматирования имени файла
каждая выборка может быть выведена в свой файл.


