#!/usr/bin/python
# -*- coding: utf-8 -*-
#-----------------------------------------------------------------------------
'''racs директория-расчета (показывает содержимое файла .RACS) либо
racs список-репозиториев/ список-выражений действие

Репозитории должны заканчиваться на символ '/'.

Выражения expr могут задаваться как [$]expr[!|!!] либо как tag+ либо как 
[~|^][title=][$]expr[?|%|#][-] где title --- имя столбца    
      ! --- выполнять выражение функцией exec для расчета, скрывать результат 
            (колонку выборки)
     !! --- выполнять выражение функцией exec в глобальном пространстве имен, 
            скрывать результат (колонку выборки)      
    ~|^ --- сортировать результаты по убыванию или возрастанию
      $ --- форматировать выражение по словарю расчета и запустить его в sh,
            результатом является строка прочитанная со стандартного вывода sh
      ? --- фильтровать по результату, по умолчанию скрывать результат 
            (колонку выборки)
      % --- добавлять пустую строку (горизонтальную линию в таблицу) 
            при изменении значения выражения
      # --- убирать строки с одинаковыми значениями выражения кроме первого 
            вхождения (аналог функции DISTINCT в SQL)
      - --- скрывать результат (колонку выборки), кроме опций ! и !!
Как альтернатива $... допускается использовать в выражении expr конструкции вида
...[/shell-command/]..., при этом shell-command форматируется по словарю расчета
запускается и заменяется результатом выполнения в виде строки без \\n.

Должно быть задано одно (и только одно) действие. Доступные действия
    --help --- показать эту справку и выйти
    --ast[able] [[head=Yes] termwidth=default] --- вывести результаты в виде 
                таблицы на стандартный вывод 
                head      --- выводить заголовок (имена столбоцов)
                termwidth --- ширина терминала
    --asd[ata] [[[head=Yes] pattern=''] filename=''] --- вывести
               результаты в формате dat--файла на стандартный вывод или
               в файл filename
               head    --- выводить заголовок (имена столбцов)
               pattern --- шаблон имен для совпадающих по выбрке параметров
                           расчетов, выводимых в заголовок dat--файла 
    --co[mmit] --- сохранить изменения расчетов (сделанные при помощи опций ! 
                   или !!) на диск
    --rm|--remove --- удалить выбранные расчеты с диска
    --keys [mode=or] --- вывести ключи (имена параметров) расчетов по всей 
           выборке, в режиме
           or  --- каждый ключ есть хотя бы в одном расчете
           and --- каждый ключ есть во всех расчетах
           xor --- каждый ключ есть только в одном расчете
    --ps|--paths [fname=''] --- вывести на стандартный вывод пути к файлу
                 fname указанном от директории расчета для всех расчетов 
                 (если он существует), по умолчанию выводятся пути к расчетам

Кроме того, доступны следующие опции (по умолчанию отключены):
    --pb[ar]|--progressbar --- отображать процесс построения выборки
    --csz|--calc-size --- определять размер расчетов (требует доп. времени)
    --ctr|--check-tree --- двигаться вглубь репозиториев, по дереву каталогов
    --force --- не запрашивать подтверждения на удаление расчетов и сохранение
                изменений
    --cl[ustering] --- разворачивает значения в первой колонке горизонтально
                       и кластеризует выборку по первой и второй колонке,
                       в результате получается двумерная таблица

Для пакетной обработки выборок используется ... [title=][$]expr: ... 

Copyright (C) 2003-2017  Antov V. Ivanov  <aiv.racs@gmail.com>
Licensed under the Apache License, Version 2.0
'''
#-----------------------------------------------------------------------------
#   parse arguments
#-----------------------------------------------------------------------------
import os, sys, cPickle, pprint

if len(sys.argv)==1 or '--help' in sys.argv: print __doc__; sys.exit()

if len(sys.argv)==2 and os.path.exists(sys.argv[1]):
    sys.path.append('')
    if os.path.isdir(sys.argv[1]): sys.argv[1] += '/.RACS'  
    X = cPickle.load(open(sys.argv[1]))
    #class Key:
    #    def __init__(self, k, v): self.k, self.sz = k, getattr(v, '__sizeof__', lambda: -1)()
    #    def __repr__(self): return repr(self.k)+'[%sB]'%self.sz if self.sz>256 else repr(self.k)
    #    def __hash__(self): return hash(self.k)
    #    def __cmp__(self, other): return cmp(self.k, other.k)
    #if type(X) is dict: X = dict((Key(k, v), v) for k, v in X.items())
    try: width = int(os.popen('stty size').readline().split()[1]) if sys.stdout.isatty() else 80
    except: width = 80
    print pprint.PrettyPrinter(width=width).pformat(X) 
    #print pprint.pformat(cPickle.load(open(sys.argv[1]))).replace('\\n','\n')
    sys.exit()

from aiwlib.mixt import *
import aiwlib.gtable, aiwlib.calc

if '--ghelp' in sys.argv: print '\n'.join(aiwlib.calc.ghelp); sys.exit()

fromL, ev_list, action, a_sz, pbar, csz, ctr, force, cl = [], [], None, len(sys.argv), False, False, False, False, False
for i in range(1, a_sz):
    arg = sys.argv[i]
    if arg in ('--ast', '--astable'):
        action = ['astable']
        if i+1<a_sz: action.append(string2bool(sys.argv[i+1])) # head on/off
        if i+2<a_sz: action.append(int(sys.argv[i+2]))         # termwidth
        break
    elif arg in ('--asd', '--asdata'):
        action = ['asdata']
        action.append(string2bool(sys.argv[i+1]) if i+3<a_sz else True)         # head on/off
        action.append(sys.argv[i+1+(i+3<a_sz)] if i+2<a_sz else '')             # pattern
        action.append(sys.argv[i+1+(i+3<a_sz)+(i+2<a_sz)] if i+1<a_sz else '')  # filename
        break
    elif arg in '--co --commit'.split(): action = ['Xcommit']; break
    elif arg in '--rm --remove'.split(): action = ['Xremove']; break
    elif arg=='--keys':
        action = ['get_keys']
        if i+1<a_sz: action.append(sys.argv[i+1]) # mode
        break
    elif arg in '--ps --paths'.split():
        action = ['paths']
        if i+1<a_sz: action.append(sys.argv[i+1]) # fname
        break        
    elif arg in '--pb --pbar --progressbar'.split(): pbar = ProgressBar(stdout=sys.stderr)
    elif arg in '--csz --calc-size'.split(): csz = True
    elif arg in '--ctr --check-tree'.split(): ctr = True
    elif arg in '--cl --clustering'.split(): cl = True
    elif arg=='--force': force = True
    elif arg.endswith('/'): fromL.append(arg)
    else: ev_list.append(arg)
else: print>>sys.stderr, __doc__, '\033[31mAction not setting!\033[0m'; sys.exit()
#-----------------------------------------------------------------------------
#   make select and call action
#-----------------------------------------------------------------------------
from aiwlib.select import Select

S = Select(fromL, ev_list, pbar, csz, ctr)
if cl: S.clusteringXY()
report = ''.join(['\033[31m']+aiwlib.calc.Calc._except_report_table+['\033[0m']) if  aiwlib.calc.Calc._except_report_table else ''
#report += 'selected %i items [%s]: %s total'%(len(S), time2string(S.runtime),
#                                              (size2string(S.c_size)+', ' if csz else '')+time2string(S.c_runtime))
report += S.report()
starttime = time.time()
if action==['Xremove']:
    print report
    if force or raw_input(' '.join([r.path for r in S.nodes()])+
                          ' (%i items total to remove, y/[any input])?'%len(S))=='y': S.Xremove()
    else: print>>sys.stderr, 'aborted'; sys.exit()
elif action==['Xcommit']:
    print report
    if force or raw_input('commit changes (%i items, y/[any input])?'%len(S))=='y': S.Xcommit()
    else: print>>sys.stderr, 'aborted'; sys.exit()
elif action[0]=='asdata' and len(S.ring)>1:
    for i in range(len(S.ring)): sys.stdout.write(''.join(S.asdata(*action[1:]))); S.click()
else:
    sep, end = ('','') if action[0][:2]=='as' else (' ','\n')
    sys.stdout.write(sep.join(getattr(S, action[0])(*action[1:]))); sys.stdout.write(end)
print>>sys.stderr, report, '... completed [%s]'%time2string(time.time()-starttime)
#-----------------------------------------------------------------------------
